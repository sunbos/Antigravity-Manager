name: Build Intel Mac

# ä¸“é—¨ç”¨äºŽæž„å»º Intel Mac ç‰ˆæœ¬çš„ Workflow
# å¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œæ— éœ€ç­‰å¾… tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 4.1.5)'
        required: true
        default: '4.1.5'
      upload_to_release:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ° GitHub Release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  VERSION: ${{ inputs.version }}
  UPLOAD_TO_RELEASE: ${{ inputs.upload_to_release == 'true' }}

jobs:
  build-intel-mac:
    name: Build Intel Mac (x86_64)
    runs-on: macos-13  # Intel Mac Runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Install dependencies
        run: |
          npm install

      - name: Build Intel Mac Version
        id: build
        env:
          # æ³¨æ„ï¼šå¦‚æžœä½ æœ‰ç­¾åè¯ä¹¦ï¼Œè¯·è®¾ç½®è¿™äº› secrets
          # TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ å¼€å§‹æž„å»º Intel Mac ç‰ˆæœ¬..."
          
          # è®¾ç½® macOS éƒ¨ç½²ç›®æ ‡ä¸º Intel
          export CMAKE_OSX_ARCHS=x86_64
          export CMAKE_OSX_DEPLOYMENT_TARGET=10.15
          
          # æ‰§è¡Œæž„å»º
          npm run tauri build -- --target x86_64-apple-darwin
          
          echo "âœ… æž„å»ºå®Œæˆï¼"
          
          # æ˜¾ç¤ºæž„å»ºäº§ç‰©
          echo "ðŸ“¦ æž„å»ºäº§ç‰©ï¼š"
          find src-tauri/target -name "*.dmg" -o -name "*.app.tar.gz" | head -20

      - name: Verify Build
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºäº§ç‰©..."
          
          # æŸ¥æ‰¾ Intel Mac æž„å»ºäº§ç‰©
          INTEL_DMG=$(find src-tauri/target -path "*x86_64*" -name "*.dmg" 2>/dev/null | head -1)
          INTEL_APP=$(find src-tauri/target -path "*x86_64*" -name "*.app.tar.gz" 2>/dev/null | head -1)
          
          if [ -n "$INTEL_DMG" ]; then
            echo "âœ… æ‰¾åˆ° DMG å®‰è£…åŒ…: $INTEL_DMG"
            ls -lh "$INTEL_DMG"
          elif [ -n "$INTEL_APP" ]; then
            echo "âœ… æ‰¾åˆ° App tarball: $INTEL_APP"
            ls -lh "$INTEL_APP"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢„æœŸçš„ Intel Mac æž„å»ºäº§ç‰©"
            echo "ðŸ“ æ‰€æœ‰å¯èƒ½çš„æž„å»ºäº§ç‰©ï¼š"
            find src-tauri/target -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.zip" 2>/dev/null | head -20
          fi

      - name: Upload as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Antigravity-Manager-Intel-Mac-v${{ env.VERSION }}
          path: |
            src-tauri/target/**/release/bundle/dmg/*.dmg
            src-tauri/target/**/release/bundle/*.app.tar.gz
            src-tauri/target/**/release/bundle/*.sig
          compression-level: 9
          retention-days: 7

      - name: Upload to GitHub Release (Optional)
        if: env.UPLOAD_TO_RELEASE == 'true'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.VERSION }}-intel-mac
          name: "Antigravity Tools v${{ env.VERSION }} (Intel Mac)"
          body: |
            ## Intel Mac ç‰ˆæœ¬ (x86_64)
            
            **ç‰ˆæœ¬**: ${{ env.VERSION }}
            **æž¶æž„**: Intel Mac (x86_64)
            **æž„å»ºæ—¶é—´**: ${{ github.run_timestamp }}
            
            ### å®‰è£…è¯´æ˜Ž
            1. ä¸‹è½½ `.dmg` æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€å¹¶æ‹–åŠ¨åˆ° Applications æ–‡ä»¶å¤¹
            3. é¦–æ¬¡æ‰“å¼€æ—¶å¯èƒ½éœ€è¦åœ¨ç»ˆç«¯æ‰§è¡Œï¼š
               ```bash
               sudo xattr -rd com.apple.quarantine "/Applications/Antigravity Tools.app"
               ```
            
            ### SHA256 æ ¡éªŒ
            ```bash
            shasum -a 256 Antigravity-Manager_*.dmg
            ```
          draft: false
          prerelease: false
          files: |
            src-tauri/target/**/release/bundle/dmg/*.dmg
            src-tauri/target/**/release/bundle/*.app.tar.gz
            src-tauri/target/**/release/bundle/*.sig

  summary:
    name: Build Summary
    needs: build-intel-mac
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## âœ… Intel Mac æž„å»ºä»»åŠ¡å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºæ—¶é—´**: ${{ github.run_timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- Intel Mac DMG å®‰è£…åŒ…" >> $GITHUB_STEP_SUMMARY
          echo "- App tarball (å¤‡ç”¨)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ Artifacts: åœ¨ Actions é¡µé¢ç‚¹å‡» Artifacts ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "2. æˆ–é‡æ–°è¿è¡Œå¹¶é€‰æ‹©ä¸Šä¼ åˆ° Release" >> $GITHUB_STEP_SUMMARY
